{% extends "base.html" %}
{% load static %}

{% block title %}Team: {{ team.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/team.css' %}">
{% endblock %}

{% block content %}
<div class="container team-view py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="team-name display-4">{{ team.name }}</h1>
            <p class="team-code lead">Team Code: <strong>{{ team.code }}</strong></p>
            {% if joined_team %}
            <div class="alert alert-success">
                You've joined this team as <strong>{{ request.session.team_role }}</strong>!
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Team Members</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group" id="team-members-list">
                        {% for member in team.members.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ member.role }}
                            {% if member.id == request.session.team_member_id %}
                            <span class="badge bg-primary">You</span>
                            {% endif %}
                        </li>
                        {% empty %}
                        <li class="list-group-item">No members have joined this team yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            {% if lobby %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Lobby: {{ lobby.name }}</h3>
                </div>
                <div class="card-body">
                    <p>Waiting for the hunt to start...</p>
                    <div id="lobby-status" class="alert alert-info">
                        {% if lobby.hunt_started %}
                        <p>The hunt has started!</p>
                        {% else %}
                        <p>Waiting for the organizer to start the hunt...</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Team Actions</h3>
                </div>
                <div class="card-body">
                    {% if not joined_team %}
                    <h4>Join This Team</h4>
                    <form method="post" action="{% url 'join_team' team.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="role" class="form-label">Your Role in the Team</label>
                            <input type="text" class="form-control" id="role" name="role" required
                                placeholder="Navigator, Driver, etc.">
                            <div class="form-text">What's your job on this team?</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Join Team</button>
                    </form>
                    {% else %}
                    <div class="d-grid gap-2">
                        {% if lobby and lobby.hunt_started and lobby.race %}
                        <a href="{% url 'race_questions' lobby.race.id %}" class="btn btn-success">Go to Hunt</a>
                        {% endif %}
                        <a href="{% url 'leave_team' team.id %}" class="btn btn-danger">Leave Team</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if is_race_active and race %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title mb-0">Race Information</h3>
                </div>
                <div class="card-body">
                    <p>Race Name: {{ race.name }}</p>
                    <p>Date: {{ race.date }}</p>
                    <p>Total Questions: {{ race.questions.count }}</p>
                    <div class="d-grid">
                        <a href="{% url 'race_questions' race.id %}" class="btn btn-primary">Go to Questions</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Race Started Notification Modal -->
<div class="modal fade" id="raceStartedModal" tabindex="-1" aria-labelledby="raceStartedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="raceStartedModalLabel">Race Started!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The race has started! You will be redirected to the questions page in <span id="redirect-countdown">5</span> seconds.</p>
                <div class="progress">
                    <div id="redirect-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="go-to-race-now-btn" class="btn btn-primary">Go to Race Now</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Regular JavaScript without Django template variables in JavaScript
        const hasLobby = {% if lobby %}true{% else %}false{% endif %};
        const hasRace = {% if race %}true{% else %}false{% endif %};
        const lobbyStarted = {% if lobby and lobby.hunt_started %}true{% else %}false{% endif %};
        const raceId = {% if race %}{{ race.id }}{% else %}null{% endif %};
        const lobbyRaceId = {% if lobby and lobby.race %}{{ lobby.race.id }}{% else %}null{% endif %};
        
        // Show race started notification if needed
        if (hasLobby && lobbyStarted && lobbyRaceId) {
            const redirectUrl = `/race/${lobbyRaceId}/questions/`;
            showRaceStartedNotification(redirectUrl);
        }
        
        // Connect to WebSocket if we have a race
        if (hasRace && raceId) {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = `${protocol}${window.location.host}/ws/race/${raceId}/`;
            
            try {
                const socket = new WebSocket(wsUrl);
                
                socket.onopen = function(e) {
                    console.log('WebSocket connection established');
                };
                
                socket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    console.log('WebSocket message received:', data);
                    
                    if (data.type === 'race_started') {
                        const url = data.redirect_url || `/race/${raceId}/questions/`;
                        showRaceStartedNotification(url);
                    }
                };
                
                socket.onerror = function(e) {
                    console.error('WebSocket error:', e);
                };
                
                socket.onclose = function(e) {
                    console.log('WebSocket connection closed');
                };
            } catch (err) {
                console.error('Failed to connect to WebSocket:', err);
            }
        }
    });
    
    function showRaceStartedNotification(redirectUrl) {
        // Update the button URL
        const goToRaceButton = document.getElementById('go-to-race-now-btn');
        if (goToRaceButton) {
            goToRaceButton.href = redirectUrl;
        }
        
        // Show the modal
        const modalElement = document.getElementById('raceStartedModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Start countdown
            let seconds = 5;
            const countdownElement = document.getElementById('redirect-countdown');
            const progressBar = document.getElementById('redirect-progress');
            
            const interval = setInterval(function() {
                seconds--;
                
                if (countdownElement) {
                    countdownElement.textContent = seconds;
                }
                
                if (progressBar) {
                    progressBar.style.width = (seconds / 5 * 100) + '%';
                }
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    window.location.href = redirectUrl;
                }
            }, 1000);
            
            // Clear interval if modal is closed
            modalElement.addEventListener('hidden.bs.modal', function() {
                clearInterval(interval);
            });
        }
    }
</script>
{% endblock %} 