{% extends "base.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="title-block">
    <h1>Leaderboard</h1>
</div>

<div class="welcome-text">
    <p>Follow the teams' progress as they solve challenges!</p>
</div>

<div class="leaderboard-container">
    <div class="dashboard-box">
        <div class="dashboard-header">
            <h2>Team Rankings</h2>
            <!-- Removed: Live updates indicator and refresh button -->
            <div class="race-select-container">
                <select id="lobby-select" class="lobby-selector">
                    <option value="all">All Races</option>
                    {% for race in races %}
                        <option value="{{ race.id }}">{{ race.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="scoreboard">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Team Name</th>
                        <th>Score</th>
                        <th>Race</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Teams will be added here dynamically -->
                    <tr>
                        <td colspan="3" class="no-teams">Loading teams...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .dashboard-box {
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .dashboard-header h2 {
        margin: 0;
        color: #333;
        font-size: 1.8rem;
    }
    
    .race-select-container {
        margin: 10px 0;
    }
    
    .lobby-selector {
        padding: 8px 16px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background-color: #f8f8f8;
        cursor: pointer;
        font-size: 14px;
    }
    
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .leaderboard-table th {
        background-color: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #eaeaea;
    }
    
    .leaderboard-table td {
        padding: 12px;
        border-bottom: 1px solid #eaeaea;
    }
    
    .team-name {
        font-weight: 500;
    }
    
    .team-score {
        font-weight: 600;
        text-align: center;
    }
    
    .no-teams {
        text-align: center;
        padding: 30px;
        color: #888;
        font-style: italic;
    }
    
    .updated {
        animation: highlight 3s ease-out;
    }
    
    .new-team {
        animation: newTeamHighlight 3s ease-out;
    }
    
    .score-increased {
        position: relative;
    }
    
    .score-increased::after {
        content: 'â†‘';
        color: #90C83C;
        font-weight: bold;
        margin-left: 4px;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(144, 200, 60, 0.3); }
        100% { background-color: transparent; }
    }
    
    @keyframes newTeamHighlight {
        0% { background-color: rgba(100, 149, 237, 0.3); }
        100% { background-color: transparent; }
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .race-select-container {
            margin-top: 15px;
            width: 100%;
        }
        
        .lobby-selector {
            width: 100%;
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 8px;
            font-size: 0.9rem;
        }
    }
</style>

<script>
    // Test data to ensure the leaderboard is not empty at startup
    const testTeams = [
        { id: 1, name: "Team Alpha", score: 1500, lobby_id: "1", lobby_name: "Race A" },
        { id: 2, name: "Team Beta", score: 1200, lobby_id: "1", lobby_name: "Race A" },
        { id: 3, name: "Team Gamma", score: 900, lobby_id: "2", lobby_name: "Race B" }
    ];
    
    let socket;
    let lastUpdateTime = Date.now();
    let connectionAttempts = 0;
    let usingFallback = false;
    let reconnecting = false;
    
    const DEBUG = true;
    function debug(message, data = null) {
        if (!DEBUG) return;
        if (data) {
            console.log(`[Leaderboard Debug] ${message}`, data);
        } else {
            console.log(`[Leaderboard Debug] ${message}`);
        }
    }
    
    // Initialize WebSocket connection
    function initWebSocket() {
        if (reconnecting) return;
        
        try {
            const wsScheme = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${wsScheme}//${window.location.host}/ws/leaderboard/`;
            debug(`Attempting WebSocket connection to ${socketUrl}`);
            
            socket = new WebSocket(socketUrl);
            window.socket = socket; // Store globally for debugging
            
            socket.onopen = function() {
                debug('WebSocket connected successfully');
                connectionAttempts = 0;
                usingFallback = false;
                reconnecting = false;
                
                // Request initial data
                socket.send(JSON.stringify({
                    action: 'get_data'
                }));
            };
            
            socket.onmessage = function(event) {
                debug('WebSocket message received', event.data);
                try {
                    const data = JSON.parse(event.data);
                    lastUpdateTime = Date.now();
                    
                    if (data.type === 'leaderboard_update') {
                        // Handle different message formats
                        if (data.teams) {
                            // Format 1: Full teams array
                            debug(`Received complete teams list: ${data.teams.length} teams`);
                            updateLeaderboard(data.teams);
                        } else if (data.action === 'full_refresh' && data.data) {
                            // Format 2: Full refresh with data array
                            debug(`Received full_refresh data: ${data.data.length} teams`);
                            updateLeaderboard(data.data);
                        } else if (data.action === 'update' && data.team_id) {
                            // Format 3: Single team update - refresh all data
                            debug(`Received single team update for team ${data.team_id} - requesting full refresh`);
                            fetchLeaderboardData(); // Get fresh data for all teams
                        } else if (data.action === 'refresh') {
                            // Format 4: Request to refresh data
                            debug('Received refresh request - fetching new data');
                            fetchLeaderboardData();
                        }
                    } else if (data.type === 'error') {
                        debug(`Server reported error: ${data.message}`, true);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error);
                }
            };
            
            socket.onclose = function(event) {
                debug(`WebSocket closed with code: ${event.code}, reason: ${event.reason}`);
                
                // Attempt to reconnect
                reconnecting = true;
                setTimeout(() => {
                    reconnecting = false;
                    connectionAttempts++;
                    
                    if (connectionAttempts <= 5) {
                        debug(`Reconnection attempt ${connectionAttempts}/5`);
                        initWebSocket();
                    } else {
                        debug('Max reconnection attempts reached, falling back to API polling');
                        fallbackToPolling();
                    }
                }, 3000);
            };
            
            socket.onerror = function(error) {
                debug('WebSocket error', error);
            };
        } catch (error) {
            console.error('Error initializing WebSocket:', error);
            fallbackToPolling();
        }
    }
    
    // Initialize real-time updates with WebSocket or fallback
    function initRealTimeUpdates() {
        debug('Initializing real-time updates');
        initWebSocket();
    }
    
    // Fall back to polling API for updates
    function fallbackToPolling() {
        if (usingFallback) return; // Prevent multiple polling intervals
        
        usingFallback = true;
        debug('Falling back to API polling every 3 seconds');
        
        // Start with an immediate data fetch
        fetchLeaderboardData();
        
        // Then poll every 3 seconds
        setInterval(function() {
            fetchLeaderboardData();
        }, 3000);
    }
    
    // Fetch leaderboard data via API
    function fetchLeaderboardData() {
        debug('Fetching leaderboard data from API');
        
        fetch('/api/leaderboard-data/')
            .then(response => response.json())
            .then(data => {
                debug('API response received', data);
                lastUpdateTime = Date.now();
                
                if (data.success && data.teams) {
                    updateLeaderboard(data.teams);
                } else {
                    debug('API error', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error fetching leaderboard data:', error);
            });
    }
    
    // Handle lobby selection filtering
    document.getElementById('lobby-select').addEventListener('change', function() {
        const selectedLobbyId = this.value;
        const teamRows = document.querySelectorAll('.team-row');
        
        debug(`Filtering by lobby: ${selectedLobbyId}`);
        
        teamRows.forEach(row => {
            const lobbyId = row.dataset.lobbyId;
            
            if (selectedLobbyId === 'all' || lobbyId === selectedLobbyId) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Update the leaderboard with team data
    function updateLeaderboard(teams) {
        const leaderboardBody = document.getElementById('leaderboard-body');
        if (!leaderboardBody) return;
        
        debug(`Updating leaderboard with ${teams.length} teams`);
        
        // Only use test data if no teams are provided AND the table is empty
        if ((!teams || !teams.length) && (!leaderboardBody.children.length || leaderboardBody.children.length === 1 && leaderboardBody.children[0].cells && leaderboardBody.children[0].cells.length === 1)) {
            debug('No teams provided and table is empty - using test data');
            teams = testTeams;
        } else if (!teams || !teams.length) {
            debug('No teams provided but table has data - keeping current data');
            return; // Keep current data if no teams are provided
        }
        
        // Clean up team data to ensure valid values
        teams = teams.map(team => {
            // Ensure team has a valid name
            if (!team.name || typeof team.name !== 'string') {
                team.name = team.team_name || `Team ${team.id}`;
            }
            
            // Check for "Team: ID" format issues and clean up
            if (team.name.includes(':')) {
                team.name = team.name.split(':')[0].trim();
                if (team.name === 'Team') {
                    team.name = `Team ${team.id}`;
                }
            }
            
            // Ensure score is a number
            team.score = parseInt(team.score) || 0;
            
            // Ensure lobby data is present
            team.lobby_id = team.lobby_id || '';
            team.lobby_name = team.lobby_name || 'Unknown Race';
            
            return team;
        });
        
        // Sort teams by score (highest first)
        teams.sort((a, b) => b.score - a.score);
        
        // Get currently selected lobby
        const selectedLobbyId = document.getElementById('lobby-select')?.value || 'all';
        
        // Get current teams for highlighting changes
        const currentTeams = {};
        document.querySelectorAll('.team-row').forEach(row => {
            const teamId = row.getAttribute('data-team-id');
            const scoreElement = row.querySelector('.team-score');
            if (teamId && scoreElement) {
                currentTeams[teamId] = {
                    score: parseInt(scoreElement.textContent) || 0,
                    element: row
                };
            }
        });
        
        // Clear and rebuild the table
        leaderboardBody.innerHTML = '';
        
        // Add teams to the table
        teams.forEach(team => {
            const row = document.createElement('tr');
            row.className = 'team-row';
            row.dataset.teamId = team.id;
            row.dataset.lobbyId = team.lobby_id;
            
            // Team name cell
            const nameCell = document.createElement('td');
            nameCell.className = 'team-name';
            nameCell.textContent = team.name;
            
            // Score cell
            const scoreCell = document.createElement('td');
            scoreCell.className = 'team-score';
            scoreCell.textContent = team.score;
            
            // Lobby name cell
            const lobbyCell = document.createElement('td');
            lobbyCell.className = 'team-lobby';
            lobbyCell.textContent = team.lobby_name;
            
            row.appendChild(nameCell);
            row.appendChild(scoreCell);
            row.appendChild(lobbyCell);
            
            // Apply filter based on selected lobby
            if (selectedLobbyId !== 'all' && team.lobby_id !== selectedLobbyId) {
                row.style.display = 'none';
            }
            
            // Highlight changed scores
            if (currentTeams[team.id] && team.score > currentTeams[team.id].score) {
                scoreCell.classList.add('score-increased');
                row.classList.add('updated');
                
                setTimeout(() => {
                    row.classList.remove('updated');
                    scoreCell.classList.remove('score-increased');
                }, 3000);
            } else if (!currentTeams[team.id]) {
                row.classList.add('new-team');
                
                setTimeout(() => {
                    row.classList.remove('new-team');
                }, 3000);
            }
            
            leaderboardBody.appendChild(row);
        });
        
        // Update last update time
        lastUpdateTime = Date.now();
    }
    
    // Initialize when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        debug('Leaderboard page loaded');
        
        // Start with test data to ensure something is displayed
        updateLeaderboard(testTeams);
        
        // Initialize real-time updates
        initRealTimeUpdates();
        
        // Set a backup timer to check for updates
        setInterval(function() {
            // If no updates for 15 seconds, try force refresh
            if (Date.now() - lastUpdateTime > 15000) {
                debug('No updates for 15 seconds, forcing refresh');
                fetchLeaderboardData();
            }
        }, 15000);
        
        // Check if there's a race ID in the URL and select it
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('race');
        if (raceId) {
            const lobbySelect = document.getElementById('lobby-select');
            if (lobbySelect) {
                lobbySelect.value = raceId;
                // Trigger the change event to filter teams
                const event = new Event('change');
                lobbySelect.dispatchEvent(event);
            }
        }
    });
</script>
{% endblock %}
