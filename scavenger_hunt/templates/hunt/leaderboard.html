{% extends "base.html" %}

{% load static %}

{% block title %}Leaderboard{% endblock %}

{% block welcome_text %}Leaderboard{% endblock %}

{% block content %}
    <div class="container py-4">
        <div class="dashboard-box p-4">
            <h2 style="color: #90C83C; text-align: center; margin-bottom: 3rem;">Leaderboard</h2>
            
            <!-- Lobby Selector -->
            <div class="lobby-selector mb-5">
                <label for="lobby-select" class="mb-3" style="color: #90C83C; display: block; font-size: 1.2rem;">Select Race:</label>
                <select id="lobby-select" class="form-control custom-select">
                    <option value="all" selected>All Races</option>
                    {% for lobby in lobbies %}
                        <option value="{{ lobby.id }}">{{ lobby.race.name }} (Code: {{ lobby.code }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="leaderboard-container" class="table-responsive mb-5">
                <table class="w-100">
                    <thead>
                        <tr>
                            <th>Team Name</th>
                            <th>Score</th>
                            <th>Race</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        {% for team in teams %}
                        <tr class="team-row" data-team-id="{{ team.id }}" data-lobby-id="{{ team.lobby_id }}">
                            <td class="team-name">{{ team.name }}</td>
                            <td class="team-score">{{ team.score }}</td>
                            <td class="team-lobby">{{ team.lobby_name }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center">No teams available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-5">
                <a href="{% url 'leader_dashboard' %}" class="btn btn-success btn-lg">Back to Dashboard</a>
            </div>
        </div>
    </div>

<style>
    .dashboard-box {
        background-color: rgba(33, 37, 41, 0.9);
        border-radius: 15px;
        border: 1px solid rgba(144, 200, 60, 0.2);
        padding: 2.5rem !important;
    }
    
    .lobby-selector {
        max-width: 500px;
        margin: 0 auto 2.5rem auto;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
    }
    
    .custom-select {
        background-color: rgba(33, 37, 41, 0.8);
        color: white;
        border: 1px solid rgba(144, 200, 60, 0.3);
        padding: 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1rem;
    }
    
    .custom-select:focus {
        border-color: #90C83C;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(144, 200, 60, 0.25);
    }
    
    .table-responsive {
        overflow-x: auto;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2.5rem;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 1.2rem;
        text-align: left;
        border-bottom: 1px solid rgba(144, 200, 60, 0.2);
    }
    
    th {
        color: #90C83C;
        font-weight: bold;
        white-space: nowrap;
        font-size: 1.2rem;
    }
    
    td {
        color: white;
        font-size: 1.1rem;
    }
    
    tr:last-child td {
        border-bottom: none;
    }
    
    tr:hover {
        background: rgba(144, 200, 60, 0.1);
    }
    
    .text-center {
        text-align: center;
    }
    
    .btn-success {
        background-color: #90C83C;
        border-color: #90C83C;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        margin-top: 1.5rem;
    }
    
    .btn-success:hover {
        background-color: #7ab32f;
        border-color: #7ab32f;
    }
    
    .team-row.updated {
        animation: highlight 2s ease-in-out;
    }
    
    .team-row.new-team {
        animation: fadeIn 2s;
    }
    
    .score-increased {
        color: #90C83C;
        font-weight: bold;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(144, 200, 60, 0.4); }
        100% { background-color: transparent; }
    }
    
    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }
    
    .websocket-status {
        margin-bottom: 15px;
        font-size: 14px;
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
        color: white;
    }
    
    .websocket-status.connected {
        color: #90C83C;
    }
    
    .websocket-status.disconnected, .websocket-status.error {
        color: #dc3545;
    }
    
    .websocket-status.reconnecting {
        color: #ffc107;
    }
    
    /* Override any button styles to ensure they're all green */
    .btn, .btn-primary, button[type="submit"] {
        background: linear-gradient(135deg, #90C83C, #7AAF2F) !important;
        color: white !important;
        border-color: #7AAF2F !important;
    }

    .btn:hover, .btn-primary:hover, button[type="submit"]:hover {
        background: linear-gradient(135deg, #7AAF2F, #618825) !important;
        color: white !important;
        border-color: #618825 !important;
    }
    
    .pulse-dot {
        display: inline-block;
        animation: pulse 2s infinite;
        margin-right: 3px;
    }
    
    @keyframes pulse {
        0% { opacity: 0.3; }
        50% { opacity: 1; }
        100% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Global variable to store all teams data
    let allTeams = [];
    
    // Create some test data to ensure the leaderboard isn't empty at startup
    const testTeams = [
        {id: 1, name: "Team A", score: 10, lobby_id: "1", lobby_name: "Test Race 1"},
        {id: 2, name: "Team B", score: 8, lobby_id: "1", lobby_name: "Test Race 1"},
        {id: 3, name: "Team C", score: 5, lobby_id: "2", lobby_name: "Test Race 2"}
    ];
    
    // Debug flag - set to true for console output
    const DEBUG = true;
    
    // Debug helper function
    function debug(message, data = null) {
        if (!DEBUG) return;
        if (data) {
            console.log(`[Leaderboard Debug] ${message}`, data);
        } else {
            console.log(`[Leaderboard Debug] ${message}`);
        }
    }
    
    // Fetch data from API
    function fetchLeaderboardData() {
        debug('Fetching leaderboard data from API');
        
        fetch('/api/leaderboard-data/')
            .then(response => response.json())
            .then(data => {
                debug('API response received', data);
                
                if (data.success && data.teams) {
                    // Store all teams
                    allTeams = cleanTeamData(data.teams);
                    
                    // Apply current filter
                    applyLobbyFilter();
                } else {
                    debug('API error', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error fetching leaderboard data:', error);
            });
    }
    
    // Clean team data to ensure valid values
    function cleanTeamData(teams) {
        return teams.map(team => {
            // Ensure team has a valid name
            if (!team.name || typeof team.name !== 'string') {
                team.name = team.team_name || `Team ${team.id}`;
            }
            
            // Check for "Team: ID" format issues and clean up
            if (team.name.includes(':')) {
                team.name = team.name.split(':')[0].trim();
                if (team.name === 'Team') {
                    team.name = `Team ${team.id}`;
                }
            }
            
            // Ensure score is a number
            team.score = parseInt(team.score) || 0;
            
            // Ensure lobby data is present and consistent type
            team.lobby_id = String(team.lobby_id || '');
            team.lobby_name = team.lobby_name || 'Unknown Race';
            
            return team;
        });
    }
    
    // Apply the current lobby filter and update display
    function applyLobbyFilter() {
        const selectedLobbyId = String(document.getElementById('lobby-select').value);
        debug(`Applying filter for lobby ID: ${selectedLobbyId}`);
        
        // Make a copy of all teams to work with
        let teamsToDisplay = [...allTeams];
        
        // Use test data if no teams available yet
        if (!teamsToDisplay.length) {
            debug('No real teams available, using test data');
            teamsToDisplay = [...testTeams];
        }
        
        // Filter teams if a specific lobby is selected
        if (selectedLobbyId !== 'all') {
            const before = teamsToDisplay.length;
            teamsToDisplay = teamsToDisplay.filter(team => {
                const teamLobbyId = String(team.lobby_id);
                const match = teamLobbyId === selectedLobbyId;
                debug(`Team ${team.name}: lobby=${teamLobbyId}, selected=${selectedLobbyId}, match=${match}`);
                return match;
            });
            debug(`Filtered from ${before} to ${teamsToDisplay.length} teams`);
        }
        
        // Sort teams by score (highest first)
        teamsToDisplay.sort((a, b) => b.score - a.score);
        
        // Now update the display with the filtered teams
        updateLeaderboardDisplay(teamsToDisplay);
    }
    
    // Update the leaderboard display with the provided teams
    function updateLeaderboardDisplay(teams) {
        const leaderboardBody = document.getElementById('leaderboard-body');
        if (!leaderboardBody) return;
        
        debug(`Updating display with ${teams.length} teams`);
        
        // Get current teams for highlighting changes
        const currentTeams = {};
        document.querySelectorAll('.team-row').forEach(row => {
            const teamId = row.getAttribute('data-team-id');
            const scoreElement = row.querySelector('.team-score');
            if (teamId && scoreElement) {
                currentTeams[teamId] = {
                    score: parseInt(scoreElement.textContent) || 0,
                    element: row
                };
            }
        });
        
        // Clear the table
        leaderboardBody.innerHTML = '';
        
        // If no teams to display, show a message
        if (teams.length === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 3;
            cell.className = 'text-center';
            cell.textContent = 'No teams available for this race';
            row.appendChild(cell);
            leaderboardBody.appendChild(row);
            return;
        }
        
        // Add each team to the table
        teams.forEach(team => {
            const row = document.createElement('tr');
            row.className = 'team-row';
            row.dataset.teamId = team.id;
            row.dataset.lobbyId = team.lobby_id;
            
            // Team name cell
            const nameCell = document.createElement('td');
            nameCell.className = 'team-name';
            nameCell.textContent = team.name;
            
            // Score cell
            const scoreCell = document.createElement('td');
            scoreCell.className = 'team-score';
            scoreCell.textContent = team.score;
            
            // Lobby name cell
            const lobbyCell = document.createElement('td');
            lobbyCell.className = 'team-lobby';
            lobbyCell.textContent = team.lobby_name;
            
            row.appendChild(nameCell);
            row.appendChild(scoreCell);
            row.appendChild(lobbyCell);
            
            // Highlight changed scores
            if (currentTeams[team.id] && team.score > currentTeams[team.id].score) {
                scoreCell.classList.add('score-increased');
                row.classList.add('updated');
                
                setTimeout(() => {
                    row.classList.remove('updated');
                    scoreCell.classList.remove('score-increased');
                }, 3000);
            } else if (!currentTeams[team.id]) {
                row.classList.add('new-team');
                
                setTimeout(() => {
                    row.classList.remove('new-team');
                }, 3000);
            }
            
            leaderboardBody.appendChild(row);
        });
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        debug('Leaderboard page loaded');
        
        // Set up the lobby select change handler
        document.getElementById('lobby-select').addEventListener('change', function() {
            debug(`Lobby selection changed to: ${this.value}`);
            applyLobbyFilter();
        });
        
        // Fetch initial data
        fetchLeaderboardData();
        
        // Set up periodic refresh
        setInterval(fetchLeaderboardData, 5000);
    });
</script>
{% endblock %}
